<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Permanenties ICT Labo</title>
  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:rgba(15, 23, 42, .10);
      --shadow: 0 10px 30px rgba(15, 23, 42, .08);
      --radius: 16px;

      --accent:#2563eb;   /* blauw */
      --soft:#eef2ff;

      --ok:#16a34a;
      --warn:#f59e0b;
      --danger:#ef4444;

      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: linear-gradient(180deg, #ffffff, var(--bg));
      color:var(--text);
    }

    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:18px 14px 26px;
    }

    header{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
      margin-bottom:12px;
    }

    h1{
      margin:0;
      font-size:22px;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: #fff;
      box-shadow: 0 6px 16px rgba(15,23,42,.06);
      font-size:12px;
      white-space:nowrap;
    }
    .pill.ok{ border-color: rgba(22,163,74,.25); background: rgba(22,163,74,.08); color: #0f3d1f; }
    .pill.warn{ border-color: rgba(245,158,11,.28); background: rgba(245,158,11,.10); color: #4a2b00; }
    .pill.err{ border-color: rgba(239,68,68,.25); background: rgba(239,68,68,.10); color: #4a0b0b; }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .section{
      padding:14px;
      border-bottom:1px solid var(--line);
    }
    .section:last-child{border-bottom:none}

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:end;
    }

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:220px;
      flex: 1;
    }
    label{
      font-size:12px;
      color:var(--muted);
    }

    input, select, button{
      font-family:inherit;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      padding:10px 10px;
      outline:none;
    }
    input::placeholder{color: rgba(100,116,139,.85)}

    button{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
      background: var(--soft);
      border-color: rgba(37,99,235,.22);
      color: #1e3a8a;
      padding:10px 12px;
      transition: transform .05s ease, filter .15s ease;
      flex: 0 0 auto;
    }
    button:active{transform:translateY(1px)}
    button:hover{filter:brightness(.98)}

    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .meta-left{
      color:var(--muted);
      font-size:12px;
    }
    .meta-right{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
    }

    .legend{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      font-weight:800;
      line-height:1;
    }
    .badge strong{
      font-family:var(--mono);
      font-size:12px;
      font-weight:900;
    }

    .badge.special{
      border-color: rgba(245,158,11,.28);
      background: rgba(245,158,11,.10);
      color:#4a2b00;
    }
    .badge.norm{
      border-color: rgba(37,99,235,.18);
      background: rgba(37,99,235,.07);
      color:#1e3a8a;
    }

    /* Extra ‚Äúvakjes‚Äù voor WACHT / HOTLINE */
    .tag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:7px 10px;
      border-radius:10px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:900;
      font-size:12px;
      letter-spacing:.2px;
    }
    .tag.wait{
      border-color: rgba(245,158,11,.35);
      background: rgba(245,158,11,.12);
      color:#4a2b00;
    }
    .tag.hotline{
      border-color: rgba(239,68,68,.30);
      background: rgba(239,68,68,.10);
      color:#4a0b0b;
    }

    table{
      width:100%;
      border-collapse:collapse;
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: #fbfcff;
      position:sticky;
      top:0;
      z-index:1;
    }
    tbody td{
      padding:12px 14px;
      border-bottom:1px solid rgba(15,23,42,.06);
      font-size:13px;
      vertical-align:middle;
    }
    tbody tr:hover{
      background: rgba(37,99,235,.04);
    }

    .person{
      font-weight:900;
      font-size:14px;
    }

    .where{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .muted{color:var(--muted)}
    .small{font-size:12px}

    .notice{
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Permanenties ICT Labo</h1>
        <div class="sub">Zoek snel op datum & persoon ‚Äî en zie meteen <b>wie waar zit</b>.</div>
      </div>
      <div class="pill" id="pillStatus">‚è≥ Laden‚Ä¶</div>
    </header>

    <div class="card">
      <div class="section">
        <div class="row">
          <div class="field">
            <label>Datum</label>
            <input type="date" id="datePicker" />
          </div>

          <div class="field">
            <label>Persoon</label>
            <select id="personSelect">
              <option value="">(Alles)</option>
            </select>
          </div>

          <div class="field">
            <label>Zoeken</label>
            <input type="text" id="globalSearch" placeholder="bv. youri, mi, hotline, wacht‚Ä¶" />
          </div>

          <button id="btnToday">üìÖ Vandaag</button>
          <button id="btnReset">üßπ Reset</button>
        </div>

        <div class="meta" style="margin-top:10px;">
          <div class="meta-left" id="metaInfo"></div>
          <div class="meta-right">
            <span class="pill" id="diagPill">üîé Codes: ‚Äî</span>
          </div>
        </div>

        <div class="legend" id="legend"></div>
        <div class="notice" id="diagText"></div>
      </div>

      <div class="section" style="padding:0;">
        <div style="max-height:70vh; overflow:auto;">
          <table>
            <thead>
              <tr>
                <th style="width:160px">Datum</th>
                <th style="width:260px">Naam</th>
                <th>Waar</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr><td colspan="3" class="muted" style="padding:14px;">Laden‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>
        <div class="section" style="border-top:1px solid var(--line); border-bottom:none;">
          <div class="muted small" id="countInfo">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ------------------------------
  // Config
  // ------------------------------
  // Zet dit exact gelijk aan je JSON-bestandsnaam in GitHub
  const DATA_URL = "permanentie.json";

  // ------------------------------
  // State
  // ------------------------------
  let payload = null;
  let records = [];
  let allPeople = [];

  // ------------------------------
  // Helpers
  // ------------------------------
  function safeText(v){ return (v === null || v === undefined) ? "" : String(v); }

  function isoTodayLocal(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

function normalizePayload(raw){
  if(raw && typeof raw === "object" && typeof raw.result === "string"){
    try {
      let parsed = JSON.parse(raw.result);

      // Als het nog altijd string is (dubbel encoded), nog eens parsen
      if(typeof parsed === "string"){
        parsed = JSON.parse(parsed);
      }

      return parsed;
    } catch(e){
      console.error("Parse error:", e);
      throw new Error("Kon raw.result niet correct parsen");
    }
  }
  return raw;
}

  function uniqueSorted(arr){
    return Array.from(new Set(arr)).sort((a,b)=> a.localeCompare(b, "nl", {sensitivity:"base"}));
  }

  function setPill(text, kind){
    const el = document.getElementById("pillStatus");
    el.className = "pill" + (kind ? (" " + kind) : "");
    el.textContent = text;
  }

  // ------------------------------
  // Mapping / vertaling
  // ------------------------------
  // HOTLINE: enkel exact "H" (case-sensitive)
  // WACHT: w/w1/w2 (case-insensitive)
  const CODE_RULES = [
    { label: "HOTLINE", tokens: ["H"], kind: "special", match: (t) => t === "H" },
    { label: "WACHT", tokens: ["w","w1","w2"], kind: "special", match: (t) => ["w","w1","w2"].includes(t.toLowerCase()) },
  ];

  function splitTokens(codeField){
    const raw = safeText(codeField).trim();
    if(!raw) return [];
    return raw.split("/").map(s => s.trim()).filter(Boolean);
  }

  function mapSingleToken(token){
    const t = safeText(token).trim();
    if(!t) return "";

    for(const rule of CODE_RULES){
      if(rule.match(t)) return rule.label;
    }
    // default: toon code zoals ze is (upper)
    return t.toUpperCase();
  }

  function mapCodeField(codeField){
    return splitTokens(codeField).map(mapSingleToken).filter(Boolean);
  }

  // ------------------------------
  // Diagnostics
  // ------------------------------
  function diagnoseCodes(){
    let countHotline = 0;  // exact "H"
    let countWacht = 0;    // w/w1/w2
    const anomalies = [];

    for(const r of records){
      const parts = splitTokens(r.code);

      for(const p of parts){
        if(p === "H") countHotline++;
        if(["w","w1","w2"].includes(p.toLowerCase())) countWacht++;

        if(p === "h"){
          anomalies.push({type:"lowercase-h", date:r.date, person:r.person, code:r.code, token:p});
        }
        if(p.includes("H") && p !== "H"){
          anomalies.push({type:"H-in-token", date:r.date, person:r.person, code:r.code, token:p});
        }
      }
    }
    return { countHotline, countWacht, anomalies };
  }

  // ------------------------------
  // UI rendering
  // ------------------------------
  function fillPeople(){
    const sel = document.getElementById("personSelect");
    const current = sel.value;
    sel.innerHTML =
      `<option value="">(Alles) ‚Äî ${allPeople.length}</option>` +
      allPeople.map(p => `<option value="${p.replace(/"/g, "&quot;")}">${p}</option>`).join("");
    if(allPeople.includes(current)) sel.value = current;
  }

  function renderLegend(){
    const wrap = document.getElementById("legend");
    wrap.innerHTML = CODE_RULES.map(r => {
      const tokenText = r.tokens.map(t => `<strong>${t}</strong>`).join(" / ");
      return `<span class="badge ${r.kind}">${tokenText} ‚Üí ${r.label}</span>`;
    }).join("");
  }

  function updateMeta(){
    const el = document.getElementById("metaInfo");
    if(!payload){ el.textContent = ""; return; }
    const gen = payload.generatedAt ? `generatedAt: ${payload.generatedAt}` : "";
    const sheet = payload.sheet ? `sheet: ${payload.sheet}` : "";
    const year = payload.year ? `year: ${payload.year}` : "";
    el.textContent = [gen, sheet, year].filter(Boolean).join(" ‚Ä¢ ");
  }

  function renderDiagnostics(){
    const pill = document.getElementById("diagPill");
    const text = document.getElementById("diagText");

    const d = diagnoseCodes();
    pill.className = "pill";
    pill.textContent = `üîé Codes gevonden: HOTLINE=${d.countHotline} ‚Ä¢ WACHT=${d.countWacht} ‚Ä¢ Verdacht=${d.anomalies.length}`;

    if(d.anomalies.length){
      pill.className = "pill warn";
      const examples = d.anomalies.slice(0,6).map(a =>
        `${a.date} ‚Ä¢ ${a.person} ‚Ä¢ "${a.code}" (token: "${a.token}")`
      ).join(" | ");
      text.innerHTML = `
        <b style="color:#7c2d12;">‚ö†Ô∏è Verdachte tokens gevonden</b><br>
        <span class="small">${examples}${d.anomalies.length > 6 ? " | ‚Ä¶" : ""}</span>
      `;
    } else {
      if(d.countHotline === 0 && d.countWacht === 0){
        pill.className = "pill";
        text.innerHTML = `<span class="small">Geen <b>H</b> of <b>w/w1/w2</b> tokens aangetroffen in de JSON (dus niets te vertalen). Als je die verwacht, zit het probleem waarschijnlijk in de brondata.</span>`;
      } else {
        pill.className = "pill ok";
        text.innerHTML = `<span class="small">Alles ok ‚Äî vertalingen worden toegepast wanneer de tokens voorkomen (H ‚Üí HOTLINE, w/w1/w2 ‚Üí WACHT).</span>`;
      }
    }
  }

  function renderTable(){
    const tbody = document.getElementById("tbody");

    const dateVal = document.getElementById("datePicker").value;
    const personVal = document.getElementById("personSelect").value.trim();
    const q = document.getElementById("globalSearch").value.trim().toLowerCase();

    let filtered = records.slice();

    if(dateVal) filtered = filtered.filter(r => safeText(r.date) === dateVal);
    if(personVal) filtered = filtered.filter(r => safeText(r.person) === personVal);

    if(q){
      filtered = filtered.filter(r => {
        const mapped = mapCodeField(r.code).join(" ");
        const hay = `${safeText(r.date)} ${safeText(r.person)} ${safeText(r.code)} ${mapped}`.toLowerCase();
        return hay.includes(q);
      });
    }

    filtered.sort((a,b) => {
      const d = safeText(b.date).localeCompare(safeText(a.date));
      if(d !== 0) return d;
      return safeText(a.person).localeCompare(safeText(b.person), "nl", {sensitivity:"base"});
    });

    if(filtered.length === 0){
      tbody.innerHTML = `<tr><td colspan="3" class="muted" style="padding:14px;">Geen resultaten.</td></tr>`;
    } else {
      tbody.innerHTML = filtered.map(r => {
        const mappedTokens = mapCodeField(r.code);

        // aparte vakjes voor WACHT / HOTLINE
        const chips = mappedTokens.map(t => {
          if(t === "WACHT") return `<span class="tag wait">WACHT</span>`;
          if(t === "HOTLINE") return `<span class="tag hotline">HOTLINE</span>`;
          return `<span class="badge norm">${t}</span>`;
        }).join("");

        return `
          <tr>
            <td>${safeText(r.date)}</td>
            <td class="person">${safeText(r.person)}</td>
            <td><div class="where">${chips || `<span class="muted">‚Äî</span>`}</div></td>
          </tr>
        `;
      }).join("");
    }

    document.getElementById("countInfo").textContent =
      `${filtered.length} resultaat/resultaten` + (dateVal ? ` ‚Ä¢ datum=${dateVal}` : "") + (personVal ? ` ‚Ä¢ persoon=${personVal}` : "");
  }

  function renderAll(){
    updateMeta();
    renderLegend();
    renderDiagnostics();
    renderTable();
  }

  // ------------------------------
  // Load
  // ------------------------------
  async function loadData(){
    setPill("‚è≥ Laden‚Ä¶");
    try{
      const res = await fetch(`${DATA_URL}?v=${Date.now()}`, { cache: "no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);

      const raw = await res.json();
      payload = normalizePayload(raw);

      if(!payload || !Array.isArray(payload.records)){
        console.log("RAW:", raw);
        console.log("PAYLOAD:", payload);
        throw new Error("Geen payload.records array gevonden");
      }

      records = payload.records;

      // filter de legende-rij eruit (persoon = "Legende")
      records = records.filter(r => safeText(r.person).toLowerCase() !== "legende");

      allPeople = uniqueSorted(records.map(r => safeText(r.person)).filter(Boolean));

      fillPeople();
      setPill("‚úÖ Data geladen", "ok");
      renderAll();
    } catch(e){
      console.error(e);
      setPill("‚ùå Fout bij laden", "err");
      document.getElementById("tbody").innerHTML =
        `<tr><td colspan="3" class="muted" style="padding:14px;">Fout: ${safeText(e.message)}</td></tr>`;
      document.getElementById("metaInfo").textContent = "";
      document.getElementById("legend").innerHTML = "";
      document.getElementById("diagPill").textContent = "üîé Codes: ‚Äî";
      document.getElementById("diagText").textContent = "";
      document.getElementById("countInfo").textContent = "‚Äî";
    }
  }

  // ------------------------------
  // Bind UI
  // ------------------------------
  function bindUI(){
    const datePicker = document.getElementById("datePicker");
    const personSelect = document.getElementById("personSelect");
    const globalSearch = document.getElementById("globalSearch");

    datePicker.value = isoTodayLocal();

    datePicker.addEventListener("change", renderAll);
    personSelect.addEventListener("change", renderAll);
    globalSearch.addEventListener("input", renderAll);

    document.getElementById("btnToday").addEventListener("click", () => {
      datePicker.value = isoTodayLocal();
      personSelect.value = "";
      globalSearch.value = "";
      renderAll();
    });

    document.getElementById("btnReset").addEventListener("click", () => {
      datePicker.value = "";
      personSelect.value = "";
      globalSearch.value = "";
      renderAll();
    });
  }

  bindUI();
  loadData();
</script>
</body>
</html>
