<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Permanenties ICT Labo</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#111a2e;
      --panel2:#0f172a;
      --text:#e6e9f2;
      --muted:#a9b1c7;
      --line:rgba(255,255,255,.08);
      --accent:#4ea1ff;
      --accent2:#22c55e;
      --danger:#ef4444;
      --warn:#f59e0b;
      --shadow: 0 8px 30px rgba(0,0,0,.35);
      --radius: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 10% 0%, rgba(78,161,255,.18), transparent 55%),
                  radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.16), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      padding:24px 18px 10px;
      max-width:1100px;
      margin:0 auto;
    }
    .title{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size:28px;
      letter-spacing:.2px;
    }
    .sub{
      color:var(--muted);
      font-size:13px;
      margin-top:6px;
    }
    main{
      max-width:1100px;
      margin:0 auto;
      padding:14px 18px 30px;
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .card-header{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .card-header h2{
      margin:0;
      font-size:15px;
      letter-spacing:.2px;
      color:#f0f3ff;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background:rgba(78,161,255,.12);
      border:1px solid rgba(78,161,255,.25);
      color:#cfe6ff;
      font-size:12px;
      white-space:nowrap;
    }
    .grid{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:10px;
    }
    .field{
      grid-column: span 3;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:180px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
    }
    input, select, button, textarea{
      font-family:inherit;
      border-radius:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:10px 10px;
      outline:none;
    }
    input::placeholder{color: rgba(230,233,242,.45)}
    textarea{
      min-height:160px;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.35;
      resize:vertical;
    }
    button{
      cursor:pointer;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
      display:inline-flex;
      gap:8px;
      align-items:center;
      justify-content:center;
      white-space:nowrap;
    }
    button:active{transform:translateY(1px)}
    .btn-primary{
      background: rgba(78,161,255,.18);
      border-color: rgba(78,161,255,.35);
    }
    .btn-primary:hover{background: rgba(78,161,255,.24)}
    .btn-success{
      background: rgba(34,197,94,.16);
      border-color: rgba(34,197,94,.32);
    }
    .btn-success:hover{background: rgba(34,197,94,.22)}
    .btn-ghost{
      background: rgba(255,255,255,.02);
    }
    .btn-warn{
      background: rgba(245,158,11,.16);
      border-color: rgba(245,158,11,.35);
    }
    .btn-danger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.35);
    }
    .actions{
      grid-column: span 12;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-start;
      padding-top:2px;
    }

    .table-wrap{overflow:auto}
    table{
      width:100%;
      border-collapse:collapse;
      min-width:700px;
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
      position:sticky; top:0;
    }
    tbody td{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:13px;
    }
    tbody tr:hover{
      background: rgba(255,255,255,.03);
    }
    .code{
      font-family:var(--mono);
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:inline-block;
    }
    .muted{color:var(--muted)}
    .right{margin-left:auto}
    .split{
      display:grid;
      grid-template-columns: 1fr;
    }
    .notice{
      padding:10px 14px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
    }
    .status{
      font-family:var(--mono);
      font-size:12px;
      color:#cfe6ff;
    }

    @media (max-width: 860px){
      .field{grid-column: span 6}
    }
    @media (max-width: 520px){
      .field{grid-column: span 12}
      table{min-width: 560px}
    }
  </style>
</head>

<body>
  <header>
    <div class="title">
      <div>
        <h1>Permanenties ICT Labo</h1>
        <div class="sub">Filter op datum & persoon ‚Äî data komt uit <span class="code">permanentie.json</span></div>
      </div>
      <div class="pill" id="pillStatus">‚è≥ Laden‚Ä¶</div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="card-header">
        <h2>Filters</h2>
        <div class="status" id="metaInfo"></div>
      </div>

      <div class="grid">
        <div class="field">
          <label>Datum</label>
          <input type="date" id="datePicker" />
        </div>

        <div class="field">
          <label>Persoon</label>
          <select id="personSelect">
            <option value="">(Alles)</option>
          </select>
        </div>

        <div class="field">
          <label>Code bevat</label>
          <input type="text" id="codeFilter" placeholder="bv. mi, sa, kv, jp‚Ä¶" />
        </div>

        <div class="field">
          <label>Zoek (persoon/code/datum)</label>
          <input type="text" id="globalSearch" placeholder="vrije zoekterm‚Ä¶" />
        </div>

        <div class="actions">
          <button class="btn-primary" id="btnToday">üìÖ Vandaag</button>
          <button class="btn-ghost" id="btnClear">üßπ Reset</button>
          <button class="btn-success" id="btnReload">üîÑ Herladen</button>
          <button class="btn-warn right" id="btnToggleEditor">üõ†Ô∏è Data aanpassen</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:170px">Datum</th>
              <th style="width:260px">Persoon</th>
              <th>Code</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="3" class="muted">Laden‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <div class="notice" id="countInfo">‚Äî</div>
    </section>

    <section class="card" id="editorCard" style="display:none">
      <div class="card-header">
        <h2>Data aanpassen (lokaal)</h2>
        <div class="pill" style="background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.28);color:#ffe6bf">
          ‚ö†Ô∏è Dit wijzigt je GitHub niet automatisch
        </div>
      </div>

      <div class="grid">
        <div class="field" style="grid-column: span 12;">
          <label>Plak hier de ‚Äúechte‚Äù payload JSON (met <span class="code">records</span>) of je huidige wrapper JSON (met <span class="code">result</span>)</label>
          <textarea id="jsonEditor" spellcheck="false"></textarea>
        </div>

        <div class="actions">
          <button class="btn-success" id="btnApplyJson">‚úÖ Toepassen</button>
          <button class="btn-primary" id="btnFillFromLoaded">üì• Vul met huidige data</button>
          <button class="btn-ghost" id="btnDownload">‚¨áÔ∏è Download JSON</button>
          <button class="btn-danger right" id="btnCloseEditor">‚úñ Sluiten</button>
        </div>

        <div class="field" style="grid-column: span 12;">
          <div class="muted" id="editorHint">
            Tip: je kan de wrapper wegdoen en gewoon opslaan als:
            <span class="code">{ "generatedAt": "...", "sheet": "...", "year": 2026, "records": [ ... ] }</span>
          </div>
        </div>
      </div>
    </section>
  </main>

<script>
  // ------------------------------
  // Config
  // ------------------------------
  const DATA_URL = "permanentie.json"; // in dezelfde folder

  // ------------------------------
  // State
  // ------------------------------
  let rawLoaded = null;       // wat fetch returnt
  let payload = null;         // echte object met records
  let records = [];           // payload.records
  let allPeople = [];

  // ------------------------------
  // Helpers
  // ------------------------------
  function isoTodayLocal(){
    const d = new Date();
    // lokale datum naar YYYY-MM-DD (zonder timezone-shift issues)
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function setPill(text, ok=null){
    const pill = document.getElementById("pillStatus");
    pill.textContent = text;
    if(ok === true){
      pill.style.background = "rgba(34,197,94,.16)";
      pill.style.borderColor = "rgba(34,197,94,.32)";
      pill.style.color = "#d9ffe9";
    } else if(ok === false){
      pill.style.background = "rgba(239,68,68,.14)";
      pill.style.borderColor = "rgba(239,68,68,.35)";
      pill.style.color = "#ffd3d3";
    } else {
      pill.style.background = "rgba(78,161,255,.12)";
      pill.style.borderColor = "rgba(78,161,255,.25)";
      pill.style.color = "#cfe6ff";
    }
  }

  function normalizePayload(data){
    // 1) wrapper met result als string JSON
    if(data && typeof data === "object" && data.result && typeof data.result === "string"){
      try { return JSON.parse(data.result); }
      catch { throw new Error("Kon data.result niet parsen als JSON"); }
    }
    // 2) payload is al direct de juiste JSON
    return data;
  }

  function safeText(v){
    return (v === null || v === undefined) ? "" : String(v);
  }

  function uniqueSorted(arr){
    return Array.from(new Set(arr)).sort((a,b)=> a.localeCompare(b, "nl", {sensitivity:"base"}));
  }

  // ------------------------------
  // Rendering
  // ------------------------------
  function fillPeople(){
    const sel = document.getElementById("personSelect");
    const current = sel.value;
    sel.innerHTML = `<option value="">(Alles)</option>` + allPeople.map(p => {
      const esc = p.replace(/"/g, "&quot;");
      return `<option value="${esc}">${p}</option>`;
    }).join("");
    // restore selection if possible
    if(allPeople.includes(current)) sel.value = current;
  }

  function render(){
    const tbody = document.getElementById("tbody");
    if(!payload || !Array.isArray(records)){
      tbody.innerHTML = `<tr><td colspan="3" class="muted">Geen geldige records gevonden.</td></tr>`;
      document.getElementById("countInfo").textContent = "‚Äî";
      return;
    }

    const dateVal = document.getElementById("datePicker").value;
    const personVal = document.getElementById("personSelect").value.trim();
    const codeVal = document.getElementById("codeFilter").value.trim().toLowerCase();
    const global = document.getElementById("globalSearch").value.trim().toLowerCase();

    let filtered = records.slice();

    if(dateVal){
      filtered = filtered.filter(r => safeText(r.date) === dateVal);
    }
    if(personVal){
      filtered = filtered.filter(r => safeText(r.person) === personVal);
    }
    if(codeVal){
      filtered = filtered.filter(r => safeText(r.code).toLowerCase().includes(codeVal));
    }
    if(global){
      filtered = filtered.filter(r => {
        const hay = `${safeText(r.date)} ${safeText(r.person)} ${safeText(r.code)}`.toLowerCase();
        return hay.includes(global);
      });
    }

    if(filtered.length === 0){
      tbody.innerHTML = `<tr><td colspan="3" class="muted">Geen resultaten voor deze filters.</td></tr>`;
    } else {
      tbody.innerHTML = filtered.map(r => `
        <tr>
          <td>${safeText(r.date)}</td>
          <td>${safeText(r.person)}</td>
          <td><span class="code">${safeText(r.code)}</span></td>
        </tr>
      `).join("");
    }

    const total = records.length;
    document.getElementById("countInfo").textContent =
      `Toont ${filtered.length} van ${total} records` + (dateVal ? ` ‚Ä¢ Datum: ${dateVal}` : "") + (personVal ? ` ‚Ä¢ Persoon: ${personVal}` : "");
  }

  function updateMeta(){
    const meta = document.getElementById("metaInfo");
    if(!payload){ meta.textContent = ""; return; }

    const gen = payload.generatedAt ? `generatedAt: ${payload.generatedAt}` : "";
    const sheet = payload.sheet ? `sheet: ${payload.sheet}` : "";
    const year = payload.year ? `year: ${payload.year}` : "";
    const parts = [gen, sheet, year].filter(Boolean);

    meta.textContent = parts.join(" ‚Ä¢ ");
  }

  // ------------------------------
  // Load
  // ------------------------------
  async function loadData(){
    setPill("‚è≥ Laden‚Ä¶");
    try{
      const res = await fetch(DATA_URL + "?_=" + Date.now(), { cache: "no-store" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      rawLoaded = await res.json();

      payload = normalizePayload(rawLoaded);
      if(!payload || !Array.isArray(payload.records)) {
        throw new Error("Geen payload.records array gevonden");
      }

      records = payload.records;

      allPeople = uniqueSorted(records.map(r => safeText(r.person)).filter(Boolean));
      fillPeople();
      updateMeta();

      setPill("‚úÖ Data geladen", true);
      render();
    } catch(e){
      console.error(e);
      setPill("‚ùå Fout bij laden", false);
      document.getElementById("tbody").innerHTML = `<tr><td colspan="3" class="muted">Fout: ${safeText(e.message)}</td></tr>`;
      document.getElementById("countInfo").textContent = "‚Äî";
      document.getElementById("metaInfo").textContent = "";
    }
  }

  // ------------------------------
  // Editor / Local edits
  // ------------------------------
  function openEditor(){
    document.getElementById("editorCard").style.display = "";
  }
  function closeEditor(){
    document.getElementById("editorCard").style.display = "none";
  }

  function applyEditorJson(){
    const txt = document.getElementById("jsonEditor").value.trim();
    if(!txt){
      alert("Plak eerst JSON in het tekstvak.");
      return;
    }
    try{
      const obj = JSON.parse(txt);
      const p = normalizePayload(obj);

      if(!p || !Array.isArray(p.records)){
        alert("Deze JSON bevat geen 'records' array (of result bevat geen parseerbare JSON).");
        return;
      }

      rawLoaded = obj;
      payload = p;
      records = p.records;
      allPeople = uniqueSorted(records.map(r => safeText(r.person)).filter(Boolean));
      fillPeople();
      updateMeta();
      setPill("‚úÖ Lokale data toegepast", true);
      render();
      alert("OK ‚Äî data is lokaal toegepast (niet naar GitHub).");
    }catch(err){
      alert("JSON parse error: " + err.message);
    }
  }

  function fillEditorFromCurrent(){
    // Tip: geef de ‚Äòmooie‚Äô payload (zonder wrapper) mee om te editen
    if(payload){
      document.getElementById("jsonEditor").value = JSON.stringify(payload, null, 2);
    } else if(rawLoaded){
      document.getElementById("jsonEditor").value = JSON.stringify(rawLoaded, null, 2);
    } else {
      document.getElementById("jsonEditor").value = "";
    }
  }

  function downloadJson(){
    if(!payload){
      alert("Geen data om te downloaden.");
      return;
    }
    const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "permanentie.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
  }

  // ------------------------------
  // Wire up UI
  // ------------------------------
  function bindUI(){
    const datePicker = document.getElementById("datePicker");
    const personSelect = document.getElementById("personSelect");
    const codeFilter = document.getElementById("codeFilter");
    const globalSearch = document.getElementById("globalSearch");

    // default = vandaag
    datePicker.value = isoTodayLocal();

    datePicker.addEventListener("change", render);
    personSelect.addEventListener("change", render);
    codeFilter.addEventListener("input", render);
    globalSearch.addEventListener("input", render);

    document.getElementById("btnToday").addEventListener("click", () => {
      datePicker.value = isoTodayLocal();
      render();
    });

    document.getElementById("btnClear").addEventListener("click", () => {
      datePicker.value = "";
      personSelect.value = "";
      codeFilter.value = "";
      globalSearch.value = "";
      render();
    });

    document.getElementById("btnReload").addEventListener("click", loadData);

    document.getElementById("btnToggleEditor").addEventListener("click", () => {
      const card = document.getElementById("editorCard");
      if(card.style.display === "none") openEditor();
      else closeEditor();
    });

    document.getElementById("btnCloseEditor").addEventListener("click", closeEditor);
    document.getElementById("btnApplyJson").addEventListener("click", applyEditorJson);
    document.getElementById("btnFillFromLoaded").addEventListener("click", fillEditorFromCurrent);
    document.getElementById("btnDownload").addEventListener("click", downloadJson);
  }

  // init
  bindUI();
  loadData();
</script>
</body>
</html>
