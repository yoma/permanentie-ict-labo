<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Permanenties ICT Labo</title>
  <style>
    :root{
      --bg:#0b1220;
      --panel:#0f172a;
      --text:#e9edf7;
      --muted:#a9b1c7;
      --line:rgba(255,255,255,.08);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;

      --accent:#4ea1ff;
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;

      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 0%, rgba(78,161,255,.16), transparent 58%),
        radial-gradient(900px 600px at 90% 10%, rgba(34,197,94,.10), transparent 55%),
        var(--bg);
    }

    header{
      max-width:1100px;
      margin:0 auto;
      padding:22px 18px 10px;
    }

    .top{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size:26px;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      color:var(--muted);
      font-size:13px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:#dbe6ff;
      font-size:12px;
      white-space:nowrap;
    }

    main{
      max-width:1100px;
      margin:0 auto;
      padding:12px 18px 28px;
      display:grid;
      gap:14px;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .card-header{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .card-header h2{
      margin:0;
      font-size:14px;
      letter-spacing:.2px;
      color:#f0f3ff;
    }

    .grid{
      padding:14px;
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:10px;
      align-items:end;
    }

    .field{
      grid-column: span 4;
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:200px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
    }

    input, select, button{
      font-family:inherit;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color: var(--text);
      padding:10px 10px;
      outline:none;
    }

    button{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      white-space:nowrap;
      transition: transform .05s ease, background .15s ease, border-color .15s ease;
    }
    button:active{transform:translateY(1px)}
    .btn{
      background: rgba(78,161,255,.14);
      border-color: rgba(78,161,255,.30);
    }
    .btn:hover{background: rgba(78,161,255,.22)}

    .status{
      font-family:var(--mono);
      font-size:12px;
      color:#cfe6ff;
    }

    /* Today list */
    .today-wrap{
      padding:14px;
      display:grid;
      gap:10px;
    }
    .today-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(34,197,94,.06);
    }
    .today-left{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .name{
      font-size:16px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .when{
      font-size:12px;
      color:var(--muted);
    }
    .badges{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      font-size:12px;
      font-weight:700;
      letter-spacing:.2px;
    }
    .badge-strong{
      border-color: rgba(78,161,255,.35);
      background: rgba(78,161,255,.14);
      color:#d8ebff;
    }
    .badge-warn{
      border-color: rgba(245,158,11,.35);
      background: rgba(245,158,11,.12);
      color:#ffe7c0;
    }

    /* Table */
    .table-wrap{overflow:auto}
    table{
      width:100%;
      border-collapse:collapse;
      min-width:740px;
    }
    thead th{
      text-align:left;
      font-size:12px;
      color:var(--muted);
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.02);
      position:sticky; top:0;
    }
    tbody td{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      font-size:13px;
      vertical-align:middle;
    }
    tbody tr:hover{ background: rgba(255,255,255,.03); }

    .person-cell{
      font-size:14px;
      font-weight:800;
      letter-spacing:.2px;
    }

    .muted{color:var(--muted)}
    .notice{
      padding:10px 14px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
    }

    @media (max-width: 860px){
      .field{grid-column: span 6}
      table{min-width: 640px}
    }
    @media (max-width: 520px){
      .field{grid-column: span 12}
      table{min-width: 560px}
    }
  </style>
</head>

<body>
  <header>
    <div class="top">
      <div>
        <h1>Permanenties ICT Labo</h1>
        <div class="sub">Snelle lookup ‚Äî wie zit waar?</div>
      </div>
      <div class="pill" id="pillStatus">‚è≥ Laden‚Ä¶</div>
    </div>
  </header>

  <main>
    <section class="card">
      <div class="card-header">
        <h2>Vandaag</h2>
        <div class="status" id="metaInfo"></div>
      </div>
      <div class="today-wrap" id="todayList">
        <div class="muted">Laden‚Ä¶</div>
      </div>
    </section>

    <section class="card">
      <div class="card-header">
        <h2>Zoeken</h2>
        <div class="status" id="countInfo">‚Äî</div>
      </div>

      <div class="grid">
        <div class="field">
          <label>Datum</label>
          <input type="date" id="datePicker" />
        </div>

        <div class="field">
          <label>Persoon</label>
          <select id="personSelect">
            <option value="">(Alles)</option>
          </select>
        </div>

        <div class="field">
          <label>Vrij zoeken</label>
          <input type="text" id="globalSearch" placeholder="bv. debby, mi, hotline, wacht‚Ä¶" />
        </div>

        <div class="field" style="grid-column: span 12; display:flex; flex-direction:row; gap:10px; align-items:center;">
          <button class="btn" id="btnToday">üìÖ Vandaag</button>
          <div class="muted" style="font-size:12px;">Tip: klik op vandaag om snel terug te keren.</div>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:170px">Datum</th>
              <th style="width:260px">Persoon</th>
              <th>Waar</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="3" class="muted">Laden‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>

      <div class="notice">
        Codes: <span class="badge badge-warn">WACHT</span> (w/w1/w2) ‚Ä¢ <span class="badge badge-warn">HOTLINE</span> (H)
      </div>
    </section>
  </main>

<script>
  // ------------------------------
  // Config
  // ------------------------------
  const DATA_URL = "permanentie.json"; // in dezelfde folder

  // ------------------------------
  // State
  // ------------------------------
  let rawLoaded = null;
  let payload = null;
  let records = [];
  let allPeople = [];

  // ------------------------------
  // Helpers
  // ------------------------------
  function isoTodayLocal(){
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth()+1).padStart(2,'0');
    const dd = String(d.getDate()).padStart(2,'0');
    return `${yyyy}-${mm}-${dd}`;
  }

  function setPill(text, ok=null){
    const pill = document.getElementById("pillStatus");
    pill.textContent = text;
    if(ok === true){
      pill.style.background = "rgba(34,197,94,.16)";
      pill.style.borderColor = "rgba(34,197,94,.32)";
      pill.style.color = "#d9ffe9";
    } else if(ok === false){
      pill.style.background = "rgba(239,68,68,.14)";
      pill.style.borderColor = "rgba(239,68,68,.35)";
      pill.style.color = "#ffd3d3";
    } else {
      pill.style.background = "rgba(255,255,255,.03)";
      pill.style.borderColor = "rgba(255,255,255,.10)";
      pill.style.color = "#dbe6ff";
    }
  }

  function normalizePayload(data){
    // wrapper met result als string JSON
    if(data && typeof data === "object" && data.result && typeof data.result === "string"){
      try { return JSON.parse(data.result); }
      catch { throw new Error("Kon data.result niet parsen als JSON"); }
    }
    return data;
  }

  function safeText(v){
    return (v === null || v === undefined) ? "" : String(v);
  }

  function uniqueSorted(arr){
    return Array.from(new Set(arr)).sort((a,b)=> a.localeCompare(b, "nl", {sensitivity:"base"}));
  }

  // ---- Code mapping
  function mapSingleCode(code){
    const c = safeText(code).trim();
    const low = c.toLowerCase();

    // WACHT: w / w1 / w2 (case-insensitive)
    if(low === "w" || low === "w1" || low === "w2") return "WACHT";

    // HOTLINE: ALLEEN exact "H" (case-sensitive)
    if(c === "H") return "HOTLINE";

    // default: duidelijk tonen
    return c.toUpperCase();
  }

  function splitAndMapCodes(codeField){
    // bv "mi/sa" => ["MI","SA"]
    const raw = safeText(codeField).trim();
    if(!raw) return [];
    return raw.split("/").map(s => s.trim()).filter(Boolean).map(mapSingleCode);
  }

  // ---- Anomaly detection (zodat je fouten ziet)
  function findCodeAnomalies(){
    const issues = [];

    for(const r of records){
      const raw = safeText(r.code).trim();
      if(!raw) continue;

      const parts = raw.split("/").map(s => s.trim()).filter(Boolean);

      for(const p of parts){
        // lowercase 'h' is verdacht
        if(p === "h"){
          issues.push({ type:"lowercase-h", date:r.date, person:r.person, code:r.code, part:p });
        }
        // 'H' in een groter token is verdacht (bv "xH")
        if(p.includes("H") && p !== "H"){
          issues.push({ type:"H-in-token", date:r.date, person:r.person, code:r.code, part:p });
        }
      }
    }

    return issues;
  }

  function fillPeople(){
    const sel = document.getElementById("personSelect");
    const current = sel.value;
    sel.innerHTML = `<option value="">(Alles) ‚Äî ${allPeople.length}</option>` + allPeople.map(p => {
      const esc = p.replace(/"/g, "&quot;");
      return `<option value="${esc}">${p}</option>`;
    }).join("");
    if(allPeople.includes(current)) sel.value = current;
  }

  function updateMeta(){
    const meta = document.getElementById("metaInfo");
    if(!payload){ meta.textContent = ""; return; }

    const gen = payload.generatedAt ? `generatedAt: ${payload.generatedAt}` : "";
    const sheet = payload.sheet ? `sheet: ${payload.sheet}` : "";
    const year = payload.year ? `year: ${payload.year}` : "";
    const parts = [gen, sheet, year].filter(Boolean);

    const issues = findCodeAnomalies();
    if(issues.length){
      const examples = issues.slice(0,5)
        .map(x => `${x.date} ‚Ä¢ ${x.person} ‚Ä¢ "${x.code}" (token: "${x.part}")`)
        .join(" | ");
      meta.textContent = parts.join(" ‚Ä¢ ") + ` ‚Ä¢ ‚ö†Ô∏è ${issues.length} verdachte code(s): ${examples}`;
    } else {
      meta.textContent = parts.join(" ‚Ä¢ ");
    }
  }

  function renderToday(){
    const today = isoTodayLocal();
    const wrap = document.getElementById("todayList");

    const todays = records
      .filter(r => safeText(r.date) === today)
      .sort((a,b)=> safeText(a.person).localeCompare(safeText(b.person), "nl", {sensitivity:"base"}));

    if(todays.length === 0){
      wrap.innerHTML = `<div class="muted">Geen items voor vandaag (${today}).</div>`;
      return;
    }

    wrap.innerHTML = todays.map(r => {
      const codes = splitAndMapCodes(r.code);
      const badges = codes.map(c => {
        const isSpecial = (c === "WACHT" || c === "HOTLINE");
        return `<span class="badge ${isSpecial ? "badge-warn" : "badge-strong"}">${c}</span>`;
      }).join("");

      return `
        <div class="today-item">
          <div class="today-left">
            <div class="name">${safeText(r.person)}</div>
            <div class="when">${today}</div>
          </div>
          <div class="badges">${badges || `<span class="badge">‚Äî</span>`}</div>
        </div>
      `;
    }).join("");
  }

  function renderTable(){
    const tbody = document.getElementById("tbody");

    const dateVal = document.getElementById("datePicker").value;
    const personVal = document.getElementById("personSelect").value.trim();
    const global = document.getElementById("globalSearch").value.trim().toLowerCase();

    let filtered = records.slice();

    if(dateVal) filtered = filtered.filter(r => safeText(r.date) === dateVal);
    if(personVal) filtered = filtered.filter(r => safeText(r.person) === personVal);

    if(global){
      filtered = filtered.filter(r => {
        const mappedCodes = splitAndMapCodes(r.code).join(" ");
        const hay = `${safeText(r.date)} ${safeText(r.person)} ${safeText(r.code)} ${mappedCodes}`.toLowerCase();
        return hay.includes(global);
      });
    }

    // sort op datum (nieuwste eerst) + naam
    filtered.sort((a,b) => {
      const d = safeText(b.date).localeCompare(safeText(a.date));
      if(d !== 0) return d;
      return safeText(a.person).localeCompare(safeText(b.person), "nl", {sensitivity:"base"});
    });

    if(filtered.length === 0){
      tbody.innerHTML = `<tr><td colspan="3" class="muted">Geen resultaten.</td></tr>`;
    } else {
      tbody.innerHTML = filtered.map(r => {
        const codes = splitAndMapCodes(r.code);
        const badges = codes.map(c => {
          const isSpecial = (c === "WACHT" || c === "HOTLINE");
          return `<span class="badge ${isSpecial ? "badge-warn" : "badge-strong"}">${c}</span>`;
        }).join("");

        return `
          <tr>
            <td>${safeText(r.date)}</td>
            <td class="person-cell">${safeText(r.person)}</td>
            <td>${badges || `<span class="badge">‚Äî</span>`}</td>
          </tr>
        `;
      }).join("");
    }

    document.getElementById("countInfo").textContent =
      `${filtered.length} resultaat/resultaten` + (dateVal ? ` ‚Ä¢ ${dateVal}` : "") + (personVal ? ` ‚Ä¢ ${personVal}` : "");
  }

  function render(){
    renderToday();
    renderTable();
  }

  async function loadData(){
    setPill("‚è≥ Laden‚Ä¶");
    try{
      const res = await fetch(`${DATA_URL}?v=${Date.now()}`, { cache: "reload" });
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      rawLoaded = await res.json();

      payload = normalizePayload(rawLoaded);
      if(!payload || !Array.isArray(payload.records)) throw new Error("Geen payload.records array gevonden");

      records = payload.records;
      allPeople = uniqueSorted(records.map(r => safeText(r.person)).filter(Boolean));

      fillPeople();
      updateMeta();
      setPill("‚úÖ Data geladen", true);
      render();
    } catch(e){
      console.error(e);
      setPill("‚ùå Fout bij laden", false);
      document.getElementById("todayList").innerHTML = `<div class="muted">Fout: ${safeText(e.message)}</div>`;
      document.getElementById("tbody").innerHTML = `<tr><td colspan="3" class="muted">Fout: ${safeText(e.message)}</td></tr>`;
      document.getElementById("countInfo").textContent = "‚Äî";
      document.getElementById("metaInfo").textContent = "";
    }
  }

  function bindUI(){
    const datePicker = document.getElementById("datePicker");
    const personSelect = document.getElementById("personSelect");
    const globalSearch = document.getElementById("globalSearch");

    datePicker.value = isoTodayLocal();

    datePicker.addEventListener("change", renderTable);
    personSelect.addEventListener("change", renderTable);
    globalSearch.addEventListener("input", renderTable);

    document.getElementById("btnToday").addEventListener("click", () => {
      datePicker.value = isoTodayLocal();
      personSelect.value = "";
      globalSearch.value = "";
      render();
    });
  }

  bindUI();
  loadData();
</script>
</body>
</html>
